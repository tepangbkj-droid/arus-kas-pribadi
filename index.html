<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Arus Kas Bersama</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .container { max-width: 1024px; margin: auto; padding: 1rem; }
        .card { background-color: #fff; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease-in-out; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: #10b981; color: #fff; }
        .btn-primary:hover:not(:disabled) { background-color: #059669; }
        .btn-danger { background-color: #ef4444; color: #fff; }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; }
        .btn-secondary:hover:not(:disabled) { background-color: #d1d5db; }
        .input-field { width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db; transition: border-color 0.2s; }
        .input-field:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 40; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); padding: 1.5rem; width: 90%; max-width: 28rem; z-index: 50; }
        .message-box { position: fixed; bottom: 1.25rem; right: 1.25rem; z-index: 50; display: flex; flex-direction: column; gap: 0.5rem; }
        .message-toast { padding: 1rem; border-radius: 0.5rem; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); opacity: 0; transform: translateX(100%); animation: slideIn 0.5s forwards; }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
        .hidden { display: none; }
    </style>
</head>
<body class="p-2 sm:p-6">
    <div id="mode-selection-container">
        <div class="modal-backdrop"></div>
        <div class="modal">
            <h3 class="text-xl font-bold mb-4 text-center">Pilih Mode Penggunaan</h3>
            <p class="text-gray-600 mb-6 text-center">Pilih bagaimana Anda ingin menggunakan aplikasi ini.</p>
            <div class="space-y-4">
                <button id="select-anonymous-btn" class="btn btn-primary w-full text-lg py-3">Mode Anonim Bersama (Hanya Lihat)</button>
                <div class="text-center my-2 text-sm text-gray-400">ATAU</div>
                <div class="card p-4 bg-gray-50">
                    <h4 class="font-semibold text-center mb-3">Mode Keuangan Pasangan</h4>
                    <div class="space-y-3">
                        <input type="text" id="couple-id-input" placeholder="Masukkan ID Pasangan Anda" class="input-field text-center">
                        <button id="join-couple-btn" class="btn btn-secondary w-full">Gabung</button>
                        <button id="create-couple-btn" class="btn btn-primary w-full">Buat Ruang Baru</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div class="container">
            <header class="header mb-6 text-center">
                <div class="flex justify-end mb-2">
                    <button id="switch-mode-btn" class="btn btn-secondary btn-sm py-1 px-2 text-xs">Ganti Mode</button>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">Aplikasi Arus Kas Bersama</h1>
                <p class="text-gray-600 mt-2">Mode Aktif: <span id="active-mode-display" class="font-semibold"></span></p>
                <p class="text-xs text-gray-400 mt-2 break-all">ID Sesi Bersama: <span id="session-id">Memuat...</span></p>
            </header>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <section id="form-section" class="card lg:col-span-1">
                    <h2 class="text-xl font-semibold mb-4">Tambah Transaksi Baru</h2>
                    <form id="transaction-form" class="space-y-4">
                        <fieldset id="form-fieldset" disabled>
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                                <input type="date" id="date" required class="input-field">
                            </div>
                            <div>
                                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
                                <input type="text" id="description" placeholder="Contoh: Beli kopi" required class="input-field">
                            </div>
                            <div>
                                <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                                <select id="category" required class="input-field">
                                    <option value="Penghasilan">Penghasilan</option>
                                    <option value="Makanan & Minuman">Makanan & Minuman</option>
                                    <option value="Transportasi">Transportasi</option>
                                    <option value="Tagihan">Tagihan</option>
                                    <option value="Belanja">Belanja</option>
                                    <option value="Hiburan">Hiburan</option>
                                    <option value="Lain-lain">Lain-lain</option>
                                </select>
                            </div>
                            <div>
                                <label for="type" class="block text-sm font-medium text-gray-700 mb-1">Jenis</label>
                                <select id="type" required class="input-field">
                                    <option value="income">Pemasukan</option>
                                    <option value="expense">Pengeluaran</option>
                                </select>
                            </div>
                            <div>
                                <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Nominal (Rp)</label>
                                <input type="number" id="amount" placeholder="Contoh: 50000" required class="input-field">
                            </div>
                            <div class="flex gap-4 mt-6">
                                <button type="submit" class="btn btn-primary flex-1">Tambah</button>
                                <button type="button" id="clear-btn" class="btn btn-danger flex-1">Hapus Semua Data</button>
                            </div>
                        </fieldset>
                    </form>
                </section>
                <section id="display-section" class="lg:col-span-2 space-y-6">
                    <div class="card">
                        <h2 class="text-xl font-semibold mb-4">Ringkasan Bulanan</h2>
                        <div class="mb-4 flex gap-2 items-center">
                            <label for="month-filter" class="text-sm font-medium text-gray-700 self-center">Filter Bulan:</label>
                            <input type="month" id="month-filter" class="input-field w-auto">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                            <div class="card p-4 bg-gray-50">
                                <div class="flex justify-between items-center mb-1">
                                    <h3 class="text-sm font-medium text-gray-500">Saldo Awal</h3>
                                    <button id="edit-starting-balance-btn" title="Ubah Saldo Awal" class="text-blue-500 hover:text-blue-700 disabled:opacity-50">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>
                                    </button>
                                </div>
                                <div class="text-xl font-bold text-gray-700"><span id="starting-balance">Rp 0</span></div>
                            </div>
                            <div class="card p-4 bg-white"><h3 class="text-sm font-medium text-gray-500 mb-1">Total Pemasukan</h3><div class="text-xl font-bold text-green-600"><span id="total-income">Rp 0</span></div></div>
                            <div class="card p-4 bg-white"><h3 class="text-sm font-medium text-gray-500 mb-1">Total Pengeluaran</h3><div class="text-xl font-bold text-red-600"><span id="total-expense">Rp 0</span></div></div>
                            <div class="card p-4 bg-gray-50"><h3 class="text-sm font-medium text-gray-500 mb-1">Saldo Akhir</h3><div class="text-xl font-bold text-blue-600"><span id="final-balance">Rp 0</span></div></div>
                        </div>
                        <h3 class="text-lg font-semibold mt-6 mb-2">Ringkasan Kategori</h3>
                        <div id="category-summary" class="space-y-2 text-sm"></div>
                    </div>
                    <div class="card p-0 overflow-hidden">
                        <h2 class="text-xl font-semibold p-4 border-b">Daftar Transaksi</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left table-auto">
                                <thead><tr class="bg-gray-50 text-sm text-gray-500 uppercase tracking-wider"><th class="p-4">Tanggal</th><th class="p-4">Keterangan</th><th class="p-4">Kategori</th><th class="p-4 text-right">Nominal (Rp)</th><th id="action-header" class="p-4 text-center">Aksi</th></tr></thead>
                                <tbody id="transaction-list"></tbody>
                            </table>
                        </div>
                        <div id="pagination-controls" class="p-4 flex justify-between items-center text-sm border-t">
                            <button id="prev-page-btn" class="btn btn-secondary">Sebelumnya</button>
                            <span id="page-info" class="font-medium"></span>
                            <button id="next-page-btn" class="btn btn-secondary">Berikutnya</button>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
    
    <div id="modal-container" class="hidden">
        <div class="modal-backdrop"></div>
        <div class="modal">
            <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
            <div id="modal-body" class="text-gray-600"></div>
            <div id="modal-footer" class="mt-6 flex justify-end gap-3">
                <button id="modal-cancel-btn" class="btn btn-secondary">Batal</button>
                <button id="modal-confirm-btn" class="btn btn-primary">Konfirmasi</button>
            </div>
        </div>
    </div>
    <div id="message-box" class="message-box"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDocs, addDoc, setDoc, onSnapshot, collection, query, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM References ---
            const appContainer = document.getElementById('app-container');
            const modeSelectionContainer = document.getElementById('mode-selection-container');
            const sessionIdEl = document.getElementById('session-id');
            const activeModeDisplay = document.getElementById('active-mode-display');
            const formSection = document.getElementById('form-section');
            const displaySection = document.getElementById('display-section');
            const actionHeader = document.getElementById('action-header');
            const transactionList = document.getElementById('transaction-list');
            const transactionForm = document.getElementById('transaction-form');
            const formFieldset = document.getElementById('form-fieldset');
            const totalIncomeEl = document.getElementById('total-income');
            const totalExpenseEl = document.getElementById('total-expense');
            const finalBalanceEl = document.getElementById('final-balance');
            const startingBalanceEl = document.getElementById('starting-balance');
            const clearBtn = document.getElementById('clear-btn');
            const monthFilter = document.getElementById('month-filter');
            const categorySummaryEl = document.getElementById('category-summary');
            const editStartingBalanceBtn = document.getElementById('edit-starting-balance-btn');
            const messageBox = document.getElementById('message-box');
            const modalContainer = document.getElementById('modal-container');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const paginationControls = document.getElementById('pagination-controls');
            const prevPageBtn = document.getElementById('prev-page-btn');
            const nextPageBtn = document.getElementById('next-page-btn');
            const pageInfo = document.getElementById('page-info');
            const switchModeBtn = document.getElementById('switch-mode-btn');

            // --- App State ---
            let db, auth, sessionId, currentMode;
            let transactions = [], currentStartingBalance = 0;
            let unsubscribeBalance, unsubscribeTransactions;
            let modalConfirmCallback = null;
            let currentPage = 1;
            const itemsPerPage = 10;
            const ANONYMOUS_APP_ID = 'shared-cash-flow-anonymous';

            // --- Firebase Config ---
            const firebaseConfig = { apiKey: "AIzaSyCQsm-S_MtdfffH4xh9uBJLztui35ToilY", authDomain: "aruskaspribadi.firebaseapp.com", projectId: "aruskaspribadi" };
            
            // --- UI & Utility Functions ---
            const showMessage = (text, type = 'success', duration = 3000) => {
                const toast = document.createElement('div');
                toast.textContent = text;
                const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
                toast.className = `message-toast ${bgColor}`;
                messageBox.appendChild(toast);
                setTimeout(() => { toast.remove(); }, duration);
            };
            const showModal = (title, bodyContent, confirmText = 'Konfirmasi', onConfirm) => {
                modalTitle.textContent = title;
                modalBody.innerHTML = '';
                if (typeof bodyContent === 'string') { modalBody.textContent = bodyContent; } else { modalBody.appendChild(bodyContent); }
                modalConfirmBtn.textContent = confirmText;
                modalConfirmCallback = onConfirm;
                modalContainer.classList.remove('hidden');
                if (confirmText.toLowerCase().includes('hapus')) { modalConfirmBtn.classList.remove('btn-primary'); modalConfirmBtn.classList.add('btn-danger'); } else { modalConfirmBtn.classList.remove('btn-danger'); modalConfirmBtn.classList.add('btn-primary'); }
            };
            const hideModal = () => {
                modalContainer.classList.add('hidden');
                modalConfirmCallback = null;
            };
            const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
            const generateRandomId = () => 'pasangan-' + (Date.now().toString(36) + Math.random().toString(36).substr(2, 5));

            // --- Mode Selection & UI Adjustment ---
            const setUIMode = (isReadOnly) => {
                if (isReadOnly) {
                    formSection.classList.add('hidden');
                    editStartingBalanceBtn.classList.add('hidden');
                    actionHeader.classList.add('hidden');
                    displaySection.classList.remove('lg:col-span-2');
                    displaySection.classList.add('lg:col-span-3');
                } else {
                    formSection.classList.remove('hidden');
                    editStartingBalanceBtn.classList.remove('hidden');
                    actionHeader.classList.remove('hidden');
                    displaySection.classList.remove('lg:col-span-3');
                    displaySection.classList.add('lg:col-span-2');
                }
            };

            const enterApp = (mode, id) => {
                currentMode = mode;
                sessionId = id;
                localStorage.setItem('kas-bersama-mode', mode);
                localStorage.setItem('kas-bersama-session-id', id);

                modeSelectionContainer.style.display = 'none';
                appContainer.classList.remove('hidden');
                sessionIdEl.textContent = sessionId;
                activeModeDisplay.textContent = mode === 'couple' ? 'Keuangan Pasangan' : 'Anonim Bersama (Hanya Lihat)';

                setUIMode(mode === 'anonymous');
                initializeFirebaseAndListeners();
            };

            const handleSwitchMode = () => {
                if (unsubscribeTransactions) unsubscribeTransactions();
                if (unsubscribeBalance) unsubscribeBalance();
                localStorage.removeItem('kas-bersama-mode');
                localStorage.removeItem('kas-bersama-session-id');
                location.reload();
            };

            // --- Core App Logic ---
            const renderUI = () => {
                if (!sessionId) return;
                const [filterYear, filterMonth] = monthFilter.value.split('-');
                const monthlyTransactions = transactions.filter(trans => {
                    const transDate = new Date(trans.date + 'T00:00:00');
                    return transDate.getUTCFullYear() == filterYear && (transDate.getUTCMonth() + 1) == filterMonth;
                });
                let totalIncome = 0, totalExpense = 0;
                const categoryTotals = {};
                monthlyTransactions.forEach(trans => {
                    if (trans.type === 'income') totalIncome += trans.amount;
                    else totalExpense += trans.amount;
                    if (!categoryTotals[trans.category]) categoryTotals[trans.category] = { income: 0, expense: 0 };
                    categoryTotals[trans.category][trans.type] += trans.amount;
                });
                const finalBalance = currentStartingBalance + totalIncome - totalExpense;
                startingBalanceEl.textContent = formatCurrency(currentStartingBalance);
                totalIncomeEl.textContent = formatCurrency(totalIncome);
                totalExpenseEl.textContent = formatCurrency(totalExpense);
                finalBalanceEl.textContent = formatCurrency(finalBalance);
                finalBalanceEl.style.color = finalBalance >= 0 ? '#16a34a' : '#dc2626';
                renderCategorySummary(categoryTotals);
                const sortedTransactions = monthlyTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                const totalPages = Math.ceil(sortedTransactions.length / itemsPerPage);
                currentPage = Math.max(1, Math.min(currentPage, totalPages || 1));
                const startIndex = (currentPage - 1) * itemsPerPage;
                const paginatedTransactions = sortedTransactions.slice(startIndex, startIndex + itemsPerPage);
                transactionList.innerHTML = '';
                
                const colspan = currentMode === 'anonymous' ? 4 : 5;
                if (paginatedTransactions.length === 0) {
                    transactionList.innerHTML = `<tr><td colspan="${colspan}" class="p-4 text-center text-gray-500">Tidak ada transaksi untuk bulan ini.</td></tr>`;
                    paginationControls.classList.add('hidden');
                } else {
                    paginatedTransactions.forEach(trans => {
                        const row = document.createElement('tr');
                        row.className = `border-t ${trans.type === 'income' ? 'bg-green-100' : 'bg-red-100'}`;
                        let rowHTML = `
                            <td class="p-4 text-sm font-medium">${trans.date}</td>
                            <td class="p-4 text-sm">${trans.description}</td>
                            <td class="p-4 text-sm">${trans.category}</td>
                            <td class="p-4 text-sm font-semibold text-right ${trans.type === 'income' ? 'text-green-600' : 'text-red-600'}">${formatCurrency(trans.amount)}</td>
                        `;
                        if (currentMode !== 'anonymous') {
                            rowHTML += `
                                <td class="p-4 text-center">
                                    <button data-id="${trans.id}" class="delete-btn btn btn-danger p-2 h-8 w-8" title="Hapus Transaksi">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </td>`;
                        }
                        row.innerHTML = rowHTML;
                        transactionList.appendChild(row);
                    });
                    paginationControls.classList.remove('hidden');
                }
                pageInfo.textContent = `Halaman ${currentPage} dari ${totalPages || 1}`;
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
            };

            const renderCategorySummary = (categoryTotals) => {
                categorySummaryEl.innerHTML = '';
                const sortedCategories = Object.keys(categoryTotals).sort();
                if (sortedCategories.length === 0) { categorySummaryEl.innerHTML = `<p class="text-gray-500">Tidak ada data kategori.</p>`; return; }
                sortedCategories.forEach(category => {
                    const { income, expense } = categoryTotals[category];
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'flex justify-between items-center p-2 rounded-md even:bg-gray-50';
                    let summaryText = `<span class="font-medium">${category}</span><div class="flex gap-2">`;
                    if (income > 0) summaryText += `<span class="text-green-600 font-semibold">${formatCurrency(income)}</span>`;
                    if (expense > 0) summaryText += `<span class="text-red-600 font-semibold">${formatCurrency(expense)}</span>`;
                    summaryText += `</div>`;
                    categoryDiv.innerHTML = summaryText;
                    categorySummaryEl.appendChild(categoryDiv);
                });
            };

            // --- Firestore Handlers with Read-Only Check ---
            const handleAddTransaction = async (e) => {
                e.preventDefault();
                if (currentMode === 'anonymous') { showMessage('Aksi tidak diizinkan dalam mode ini.', 'error'); return; }
                const date = document.getElementById('date').value, description = document.getElementById('description').value, category = document.getElementById('category').value, type = document.getElementById('type').value, amount = parseFloat(document.getElementById('amount').value);
                if (!date || !description || !category || !type || isNaN(amount) || amount <= 0) { showMessage('Harap isi semua kolom.', 'error'); return; }
                try {
                    const transCollection = collection(db, 'artifacts', sessionId, 'public', 'data', 'transactions');
                    await addDoc(transCollection, { date, description, category, type, amount, createdAt: new Date().toISOString() });
                    showMessage('Transaksi berhasil ditambahkan!');
                    transactionForm.reset();
                    document.getElementById('date').value = new Date().toISOString().slice(0, 10);
                } catch (error) { showMessage('Gagal menambahkan transaksi.', 'error'); }
            };

            const handleDeleteTransaction = (transactionId) => {
                if (currentMode === 'anonymous') { showMessage('Aksi tidak diizinkan dalam mode ini.', 'error'); return; }
                showModal('Hapus Transaksi?', 'Apakah Anda yakin ingin menghapus transaksi ini?', 'Ya, Hapus', async () => {
                    hideModal();
                    try {
                        const transDocRef = doc(db, 'artifacts', sessionId, 'public', 'data', 'transactions', transactionId);
                        await deleteDoc(transDocRef);
                        showMessage('Transaksi berhasil dihapus.');
                    } catch (error) { showMessage('Gagal menghapus transaksi.', 'error'); }
                });
            };

            const handleClearAllData = async () => {
                if (currentMode === 'anonymous') { showMessage('Aksi tidak diizinkan dalam mode ini.', 'error'); return; }
                showModal('Hapus Semua Data?', `Ini akan menghapus semua data untuk sesi ID: ${sessionId}. Tindakan ini tidak dapat diurungkan.`, 'Ya, Hapus Semua', async () => {
                    hideModal();
                    try {
                        const transCollectionRef = collection(db, 'artifacts', sessionId, 'public', 'data', 'transactions');
                        const balanceCollectionRef = collection(db, 'artifacts', sessionId, 'public', 'data', 'balances');
                        const batch = writeBatch(db);
                        const [transSnapshot, balanceSnapshot] = await Promise.all([getDocs(transCollectionRef), getDocs(balanceCollectionRef)]);
                        transSnapshot.forEach(doc => batch.delete(doc.ref));
                        balanceSnapshot.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                        showMessage('Semua data berhasil dihapus.');
                    } catch (error) { showMessage('Gagal menghapus data.', 'error'); }
                });
            };

            const handleEditStartingBalance = () => {
                if (currentMode === 'anonymous') { showMessage('Aksi tidak diizinkan dalam mode ini.', 'error'); return; }
                const body = document.createElement('div');
                body.innerHTML = `<p class="mb-2">Masukkan saldo awal baru untuk bulan <strong>${monthFilter.value}</strong>.</p><input type="number" id="new-balance-input" class="input-field" placeholder="Contoh: 1000000" value="${currentStartingBalance}">`;
                showModal('Ubah Saldo Awal', body, 'Simpan', async () => {
                    const newBalance = parseFloat(document.getElementById('new-balance-input').value);
                    if (isNaN(newBalance)) { showMessage('Nilai saldo tidak valid.', 'error'); hideModal(); return; }
                    try {
                        const balanceDocRef = doc(db, 'artifacts', sessionId, 'public', 'data', 'balances', monthFilter.value);
                        await setDoc(balanceDocRef, { balance: newBalance });
                        showMessage('Saldo awal berhasil diperbarui.');
                        hideModal();
                    } catch (error) { showMessage('Gagal memperbarui saldo awal.', 'error'); hideModal(); }
                });
            };

            const setupFirestoreListeners = () => {
                if (!sessionId) return;
                if (unsubscribeTransactions) unsubscribeTransactions();
                if (unsubscribeBalance) unsubscribeBalance();
                currentPage = 1;
                const transQuery = query(collection(db, 'artifacts', sessionId, 'public', 'data', 'transactions'));
                unsubscribeTransactions = onSnapshot(transQuery, (snapshot) => {
                    transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUI();
                }, (error) => console.error("Error listening to txs:", error));
                const balanceDocRef = doc(db, 'artifacts', sessionId, 'public', 'data', 'balances', monthFilter.value);
                unsubscribeBalance = onSnapshot(balanceDocRef, (doc) => {
                    currentStartingBalance = doc.exists() ? doc.data().balance : 0;
                    renderUI();
                }, (error) => console.error("Error listening to balance:", error));
            };
            
            // --- App Initialization ---
            const initializeFirebaseAndListeners = async () => {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    onAuthStateChanged(auth, (user) => {
                        formFieldset.disabled = !user;
                        if (currentMode !== 'anonymous') {
                           editStartingBalanceBtn.disabled = !user;
                        }
                        if(user) {
                           setupFirestoreListeners();
                        }
                    });
                    await signInAnonymously(auth);
                } catch (error) {
                    showMessage('Gagal terhubung ke server.', 'error');
                }
            };
            
            const main = () => {
                // Setup event listeners
                document.getElementById('select-anonymous-btn').addEventListener('click', () => {
                    enterApp('anonymous', ANONYMOUS_APP_ID);
                });
                document.getElementById('join-couple-btn').addEventListener('click', () => {
                    const id = document.getElementById('couple-id-input').value.trim();
                    if (!id) { showMessage('Harap masukkan ID Pasangan.', 'error'); return; }
                    enterApp('couple', id);
                });
                document.getElementById('create-couple-btn').addEventListener('click', () => {
                    const newId = generateRandomId();
                    const body = document.createElement('div');
                    body.innerHTML = `<p class="mb-2">Bagikan ID ini HANYA dengan pasangan Anda:</p><input type="text" readonly value="${newId}" class="input-field bg-gray-100 text-center font-semibold text-lg"><p class="text-xs text-gray-500 mt-2">Klik 'Lanjutkan' untuk masuk.</p>`;
                    showModal('ID Pasangan Baru Anda', body, 'Lanjutkan', () => {
                        hideModal();
                        enterApp('couple', newId);
                    });
                });
                
                switchModeBtn.addEventListener('click', handleSwitchMode);
                transactionForm.addEventListener('submit', handleAddTransaction);
                clearBtn.addEventListener('click', handleClearAllData);
                editStartingBalanceBtn.addEventListener('click', handleEditStartingBalance);
                monthFilter.addEventListener('change', setupFirestoreListeners);
                transactionList.addEventListener('click', (e) => {
                    const deleteButton = e.target.closest('.delete-btn');
                    if (deleteButton) handleDeleteTransaction(deleteButton.getAttribute('data-id'));
                });
                prevPageBtn.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderUI(); } });
                nextPageBtn.addEventListener('click', () => { currentPage++; renderUI(); });
                modalCancelBtn.addEventListener('click', hideModal);
                modalConfirmBtn.addEventListener('click', () => { if (modalConfirmCallback) modalConfirmCallback(); });
                
                // Set default dates
                const today = new Date();
                document.getElementById('date').value = today.toISOString().slice(0, 10);
                monthFilter.value = today.toISOString().slice(0, 7);

                // Check for saved session
                const savedMode = localStorage.getItem('kas-bersama-mode');
                const savedSessionId = localStorage.getItem('kas-bersama-session-id');
                if (savedMode && savedSessionId) {
                    enterApp(savedMode, savedSessionId);
                } else {
                    modeSelectionContainer.style.display = 'block';
                    appContainer.classList.add('hidden');
                }
            };

            main();
        });
    </script>
</body>
</html>