<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesin Kasir Sederhana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 md:p-8">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-5xl flex flex-col md:flex-row h-auto min-h-[80vh] overflow-hidden">
        
        <div class="w-full md:w-2/3 p-6 flex flex-col">
            <h1 class="text-3xl font-bold mb-6 text-gray-800">Mesin Kasir</h1>
            
            <div class="flex border-b border-gray-200 mb-4">
                <button id="tab-makanan" class="py-2 px-4 text-center font-medium border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-indigo-600 focus:outline-none transition-colors duration-200" data-category="makanan">
                    Makanan
                </button>
                <button id="tab-minuman" class="py-2 px-4 text-center font-medium border-b-2 border-transparent text-gray-500 hover:text-indigo-600 hover:border-indigo-600 focus:outline-none transition-colors duration-200" data-category="minuman">
                    Minuman
                </button>
            </div>

            <div class="flex-1 overflow-y-auto mb-6">
                <div id="menu-items" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                    </div>
            </div>

            <div class="bg-gray-50 rounded-lg p-4">
                <h2 class="text-xl font-semibold mb-2 text-gray-700">Keranjang Belanja</h2>
                <div id="cart-items" class="overflow-y-auto max-h-40 mb-2">
                    </div>
                <div class="flex justify-between items-center font-semibold text-gray-800">
                    <span>Total:</span>
                    <span id="cart-total">Rp 0</span>
                </div>
            </div>
        </div>

        <div class="w-full md:w-1/3 bg-indigo-600 p-6 flex flex-col justify-between rounded-b-xl md:rounded-r-xl md:rounded-b-none text-white">
            
            <div class="flex border-b border-indigo-400 mb-4 overflow-x-auto whitespace-nowrap">
                <button id="tab-kasir" class="py-2 px-4 text-center font-medium border-b-2 border-white text-white focus:outline-none transition-colors duration-200" data-tab="kasir">
                    Kasir
                </button>
                <button id="tab-riwayat" class="py-2 px-4 text-center font-medium border-b-2 border-transparent text-indigo-200 hover:text-white hover:border-white focus:outline-none transition-colors duration-200" data-tab="riwayat">
                    Riwayat
                </button>
                <button id="tab-laporan" class="py-2 px-4 text-center font-medium border-b-2 border-transparent text-indigo-200 hover:text-white hover:border-white focus:outline-none transition-colors duration-200" data-tab="laporan">
                    Laporan
                </button>
                <button id="tab-manajemen" class="py-2 px-4 text-center font-medium border-b-2 border-transparent text-indigo-200 hover:text-white hover:border-white focus:outline-none transition-colors duration-200" data-tab="manajemen">
                    Manajemen
                </button>
                <button id="tab-catatan" class="py-2 px-4 text-center font-medium border-b-2 border-transparent text-indigo-200 hover:text-white hover:border-white focus:outline-none transition-colors duration-200" data-tab="catatan">
                    Catatan
                </button>
            </div>
            
            <div id="kasir-tab-content" class="tab-content flex-1 flex flex-col justify-center">
                <div id="payment-options" class="w-full">
                    <label for="payment-method" class="text-sm font-semibold mb-2 block">Pilih Metode Pembayaran</label>
                    <select id="payment-method" class="w-full p-3 rounded-lg text-gray-800 mb-4">
                        <option value="cash">Tunai</option>
                        <option value="qris">QRIS</option>
                    </select>
                </div>
                
                <div id="cash-payment-form">
                    <label for="input-bayar" class="text-sm font-semibold mb-2 block">Nominal Tunai</label>
                    <input type="number" id="input-bayar" class="w-full p-3 rounded-lg text-gray-800 mb-4" placeholder="Masukkan jumlah uang">
                </div>

                <div id="qris-payment-form" class="hidden">
                    <p class="text-center font-semibold mb-2">Scan QR code di bawah ini</p>
                    <div class="bg-white p-4 rounded-lg flex justify-center items-center">
                        <img id="qris-image" src="" alt="Kode QRIS" class="w-48 h-48 cursor-pointer" onclick="openQRISModal()">
                    </div>
                </div>

                <div id="form-bayar" class="w-full">
                    <button id="btn-bayar" class="w-full bg-white text-indigo-600 py-3 rounded-lg font-bold hover:bg-gray-200 transition-colors duration-200">
                        Proses Pembayaran
                    </button>
                </div>

                <div id="kembalian-info" class="text-center mt-4 hidden">
                    <p class="text-2xl font-bold">Kembalian</p>
                    <p id="kembalian-amount" class="text-4xl font-extrabold mt-2 text-white"></p>
                    <button id="btn-transaksi-baru" class="w-full mt-4 bg-white text-indigo-600 py-3 rounded-lg font-bold hover:bg-gray-200 transition-colors duration-200">
                        Transaksi Baru
                    </button>
                </div>
            </div>

            <div id="riwayat-tab-content" class="tab-content flex-1 hidden overflow-y-auto">
                </div>

            <div id="laporan-tab-content" class="tab-content flex-1 hidden flex flex-col">
                <h2 class="text-xl font-semibold mb-4">Tambahkan Pengeluaran</h2>
                <input type="text" id="expense-name" class="w-full p-3 rounded-lg text-gray-800 mb-2" placeholder="Nama Pengeluaran">
                <input type="number" id="expense-amount" class="w-full p-3 rounded-lg text-gray-800 mb-4" placeholder="Jumlah Pengeluaran">
                <button id="btn-tambah-pengeluaran" class="w-full bg-white text-indigo-600 py-3 rounded-lg font-bold hover:bg-gray-200 transition-colors duration-200 mb-4">
                    Tambahkan Pengeluaran
                </button>

                <h2 class="text-xl font-semibold mb-2 mt-4">Ringkasan Pengeluaran</h2>
                <div id="laporan-list" class="flex-1 overflow-y-auto">
                    </div>
            </div>

            <div id="manajemen-tab-content" class="tab-content flex-1 hidden flex flex-col">
                <h2 class="text-xl font-semibold mb-4">Tambah Menu Baru</h2>
                <select id="new-item-category" class="w-full p-3 rounded-lg text-gray-800 mb-2">
                    <option value="makanan">Makanan</option>
                    <option value="minuman">Minuman</option>
                </select>
                <input type="text" id="new-item-name" class="w-full p-3 rounded-lg text-gray-800 mb-2" placeholder="Nama Menu">
                <input type="number" id="new-item-price" class="w-full p-3 rounded-lg text-gray-800 mb-4" placeholder="Harga (contoh: 15000)">
                <button id="btn-tambah-menu" class="w-full bg-white text-indigo-600 py-3 rounded-lg font-bold hover:bg-gray-200 transition-colors duration-200 mb-4">
                    Tambah Menu
                </button>
                <h2 class="text-xl font-semibold mb-2 mt-4">Edit/Hapus Menu</h2>
                <div id="manajemen-menu-list" class="flex-1 overflow-y-auto">
                    </div>
            </div>

            <div id="catatan-tab-content" class="tab-content flex-1 hidden flex flex-col">
                <h2 class="text-xl font-semibold mb-4">Tambahkan Catatan Baru</h2>
                <textarea id="note-text" class="w-full p-3 rounded-lg text-gray-800 mb-4" rows="4" placeholder="Tulis catatan Anda di sini..."></textarea>
                <button id="btn-tambah-catatan" class="w-full bg-white text-indigo-600 py-3 rounded-lg font-bold hover:bg-gray-200 transition-colors duration-200 mb-4">
                    Simpan Catatan
                </button>
                <h2 class="text-xl font-semibold mb-2 mt-4">Daftar Catatan</h2>
                <div id="notes-list" class="flex-1 overflow-y-auto">
                    </div>
            </div>
            
            <div class="text-center mt-4">
                <p id="auth-status" class="text-sm text-indigo-200"></p>
            </div>
        </div>
    </div>

    <div id="message-modal-overlay" class="modal-overlay hidden">
        <div id="message-modal-content" class="modal-content">
            <p id="message-text" class="text-gray-800"></p>
            <button id="message-modal-close" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Tutup</button>
        </div>
    </div>

    <div id="edit-modal-overlay" class="modal-overlay hidden">
        <div id="edit-modal-content" class="modal-content">
            <h2 class="text-xl font-bold mb-4">Edit Menu</h2>
            <input type="text" id="edit-item-name" class="w-full p-3 rounded-lg text-gray-800 mb-2" placeholder="Nama Menu">
            <input type="number" id="edit-item-price" class="w-full p-3 rounded-lg text-gray-800 mb-4" placeholder="Harga (contoh: 15000)">
            <div class="flex space-x-2">
                <button id="btn-batal-edit" class="flex-1 px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Batal</button>
                <button id="btn-simpan-edit" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Simpan Perubahan</button>
            </div>
        </div>
    </div>

    <div id="edit-transaction-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content text-left">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Edit Transaksi</h2>
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-1">Total Transaksi</label>
                <input type="number" id="edit-tx-total" class="w-full p-3 rounded-lg text-gray-800" placeholder="Total Transaksi">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-1">Pesanan (format JSON string)</label>
                <textarea id="edit-tx-pesanan" rows="5" class="w-full p-3 rounded-lg text-gray-800" placeholder='{"Item 1": {"harga": 10000, "jumlah": 1}}'></textarea>
                <p class="text-xs text-gray-500 mt-1">Gunakan format JSON string untuk detail pesanan.</p>
            </div>
            <div class="flex justify-end space-x-2">
                <button id="btn-batal-edit-tx" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Batal</button>
                <button id="btn-simpan-edit-tx" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Simpan</button>
            </div>
        </div>
    </div>

    <div id="qris-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <img id="enlarged-qris-image" src="" alt="QRIS" class="w-full max-w-sm mx-auto">
            <button onclick="closeQRISModal()" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Tutup</button>
        </div>
    </div>

    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, deleteDoc, serverTimestamp, query, where, getDocs, addDoc } from     "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firebase Configuration - GANTI DENGAN KREDENSIAL PROYEK ANDA
        const firebaseConfig = {
            apiKey: "AIzaSyDxoOHCPBXZ5LFmOTBD0uHYsTh5lReJyuA",
            authDomain: "kasir-sederhana-e2d47.firebaseapp.com",
            projectId: "kasir-sederhana-e2d47",
            storageBucket: "kasir-sederhana-e2d47.firebasestorage.app",
            messagingSenderId: "446896042762",
            appId: "1:446896042762:web:b4fe9da3166a3e806f00f3"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUserId = null;
        let activeCategory = 'makanan';
        let activeTab = 'kasir';
        let editableMenuItems = [];
        let currentEditDocId = null;
        let currentEditTxDocId = null;

        let cart = {};
        let transactions = [];
        let expenses = [];
        let notes = [];
        
        // DOM Elements
        const menuItemsEl = document.getElementById('menu-items');
        const cartItemsEl = document.getElementById('cart-items');
        const cartTotalEl = document.getElementById('cart-total');
        const inputBayarEl = document.getElementById('input-bayar');
        const btnBayarEl = document.getElementById('btn-bayar');
        const kembalianInfoEl = document.getElementById('kembalian-info');
        const kembalianAmountEl = document.getElementById('kembalian-amount');
        const btnTransaksiBaruEl = document.getElementById('btn-transaksi-baru');
        const authStatusEl = document.getElementById('auth-status');
        const riwayatTabContentEl = document.getElementById('riwayat-tab-content');
        const laporanTabContentEl = document.getElementById('laporan-tab-content');
        const manajemenTabContentEl = document.getElementById('manajemen-tab-content');
        const catatanTabContentEl = document.getElementById('catatan-tab-content');
        const manajemenMenuListEl = document.getElementById('manajemen-menu-list');
        const tabButtons = document.querySelectorAll('.flex.border-b button');
        const newMenuItemCategoryEl = document.getElementById('new-item-category');
        const newMenuItemNameEl = document.getElementById('new-item-name');
        const newMenuItemPriceEl = document.getElementById('new-item-price');
        const btnTambahMenuEl = document.getElementById('btn-tambah-menu');
        const expenseNameEl = document.getElementById('expense-name');
        const expenseAmountEl = document.getElementById('expense-amount');
        const btnTambahPengeluaranEl = document.getElementById('btn-tambah-pengeluaran');
        const laporanListEl = document.getElementById('laporan-list');
        const noteTextEl = document.getElementById('note-text');
        const btnTambahCatatanEl = document.getElementById('btn-tambah-catatan');
        const notesListEl = document.getElementById('notes-list');
        const formBayarEl = document.getElementById('form-bayar');

        // Payment method DOM elements
        const paymentMethodEl = document.getElementById('payment-method');
        const cashPaymentFormEl = document.getElementById('cash-payment-form');
        const qrisPaymentFormEl = document.getElementById('qris-payment-form');
        const qrisImageEl = document.getElementById('qris-image');
        const qrisModalOverlay = document.getElementById('qris-modal-overlay');
        const enlargedQrisImageEl = document.getElementById('enlarged-qris-image');

        // Message Modal elements
        const messageModalOverlay = document.getElementById('message-modal-overlay');
        const messageModalClose = document.getElementById('message-modal-close');
        const messageText = document.getElementById('message-text');

        // Edit Menu Modal elements
        const editModalOverlay = document.getElementById('edit-modal-overlay');
        const editItemNameEl = document.getElementById('edit-item-name');
        const editItemPriceEl = document.getElementById('edit-item-price');
        const btnBatalEditEl = document.getElementById('btn-batal-edit');
        const btnSimpanEditEl = document.getElementById('btn-simpan-edit');

        // Edit Transaction Modal elements
        const editTransactionModalOverlay = document.getElementById('edit-transaction-modal-overlay');
        const editTxTotalEl = document.getElementById('edit-tx-total');
        const editTxPesananEl = document.getElementById('edit-tx-pesanan');
        const btnBatalEditTxEl = document.getElementById('btn-batal-edit-tx');
        const btnSimpanEditTxEl = document.getElementById('btn-simpan-edit-tx');


        // Event Listeners
        document.addEventListener('DOMContentLoaded', initialize);
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const category = button.dataset.category;
                const tab = button.dataset.tab;

                // Handle category tabs
                if (category) {
                    document.querySelectorAll('[data-category]').forEach(btn => {
                        btn.classList.remove('border-indigo-600', 'text-indigo-600');
                        btn.classList.add('border-transparent', 'text-gray-500');
                    });
                    button.classList.add('border-indigo-600', 'text-indigo-600');
                    activeCategory = category;
                    renderMenuItems();
                } 
                // Handle main content tabs
                else if (tab) {
                    document.querySelectorAll('[data-tab]').forEach(btn => {
                        btn.classList.remove('border-white', 'text-white');
                        btn.classList.add('border-transparent', 'text-indigo-200');
                    });
                    button.classList.add('border-white', 'text-white');
                    activeTab = tab;
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                    document.getElementById(`${tab}-tab-content`).classList.remove('hidden');
                    
                    if (activeTab === 'riwayat') {
                        renderTransactionHistory();
                    } else if (activeTab === 'laporan') {
                        renderReports();
                    } else if (activeTab === 'manajemen') {
                        renderManageableMenu();
                    } else if (activeTab === 'catatan') {
                        renderNotes();
                    }
                }
            });
        });

        paymentMethodEl.addEventListener('change', (e) => {
            if (e.target.value === 'cash') {
                cashPaymentFormEl.classList.remove('hidden');
                qrisPaymentFormEl.classList.add('hidden');
                formBayarEl.classList.remove('hidden');
            } else {
                cashPaymentFormEl.classList.add('hidden');
                qrisPaymentFormEl.classList.remove('hidden');
                formBayarEl.classList.remove('hidden');
            }
        });

        btnTambahMenuEl.addEventListener('click', async () => {
            const category = newMenuItemCategoryEl.value;
            const name = newMenuItemNameEl.value;
            const price = parseInt(newMenuItemPriceEl.value);

            if (!name || isNaN(price) || price <= 0) {
                showMessage("Nama menu dan harga harus diisi dengan benar.");
                return;
            }

            try {
                // Check if the menu item already exists
                const menuCollectionRef = collection(db, "menu");
                const q = query(menuCollectionRef, where("name", "==", name), where("category", "==", category));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    showMessage("Menu dengan nama yang sama sudah ada di kategori ini.");
                    return;
                }

                await addDoc(menuCollectionRef, {
                    name: name,
                    price: price,
                    category: category,
                    timestamp: serverTimestamp()
                });
                showMessage(`Menu '${name}' berhasil ditambahkan.`);
                newMenuItemNameEl.value = '';
                newMenuItemPriceEl.value = '';
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage("Gagal menambahkan menu. Silakan coba lagi.", true);
            }
        });

        btnTambahPengeluaranEl.addEventListener('click', async () => {
            const name = expenseNameEl.value;
            const amount = parseInt(expenseAmountEl.value);

            if (!name || isNaN(amount) || amount <= 0) {
                showMessage("Nama dan jumlah pengeluaran harus diisi dengan benar.");
                return;
            }
            try {
                const expensesRef = collection(db, `users/${currentUserId}/expenses`);
                await addDoc(expensesRef, {
                    name: name,
                    amount: amount,
                    timestamp: serverTimestamp()
                });
                showMessage(`Pengeluaran '${name}' berhasil ditambahkan.`);
                expenseNameEl.value = '';
                expenseAmountEl.value = '';
            } catch (error) {
                console.error("Error adding expense:", error);
                showMessage("Gagal menambahkan pengeluaran.", true);
            }
        });

        btnTambahCatatanEl.addEventListener('click', async () => {
            const noteText = noteTextEl.value;
            if (!noteText.trim()) {
                showMessage("Catatan tidak boleh kosong.");
                return;
            }
            try {
                const notesRef = collection(db, `users/${currentUserId}/notes`);
                await addDoc(notesRef, {
                    text: noteText,
                    timestamp: serverTimestamp()
                });
                showMessage("Catatan berhasil disimpan.");
                noteTextEl.value = '';
            } catch (error) {
                console.error("Error adding note:", error);
                showMessage("Gagal menyimpan catatan.", true);
            }
        });
        
        btnBayarEl.addEventListener('click', processPayment);
        btnTransaksiBaruEl.addEventListener('click', resetTransaksi);
        messageModalClose.addEventListener('click', () => {
            messageModalOverlay.classList.add('hidden');
        });

        btnBatalEditEl.addEventListener('click', () => {
            editModalOverlay.classList.add('hidden');
        });

        btnSimpanEditEl.addEventListener('click', async () => {
            const newName = editItemNameEl.value;
            const newPrice = parseInt(editItemPriceEl.value);

            if (!newName || isNaN(newPrice) || newPrice <= 0) {
                showMessage("Nama menu dan harga harus diisi dengan benar.");
                return;
            }

            if (currentEditDocId) {
                try {
                    await updateDoc(doc(db, "menu", currentEditDocId), {
                        name: newName,
                        price: newPrice
                    });
                    showMessage("Menu berhasil diperbarui.");
                    editModalOverlay.classList.add('hidden');
                } catch (error) {
                    console.error("Error updating document: ", error);
                    showMessage("Gagal memperbarui menu. Silakan coba lagi.", true);
                }
            }
        });

        btnBatalEditTxEl.addEventListener('click', () => {
            editTransactionModalOverlay.classList.add('hidden');
        });

        btnSimpanEditTxEl.addEventListener('click', async () => {
            const newTotal = parseInt(editTxTotalEl.value);
            const newPesanan = editTxPesananEl.value;

            if (isNaN(newTotal) || newTotal <= 0 || !newPesanan) {
                showMessage("Data transaksi tidak valid.", true);
                return;
            }

            try {
                // Validate if pesanan is a valid JSON string
                JSON.parse(newPesanan);
                
                if (currentEditTxDocId) {
                    await updateDoc(doc(db, "transactions", currentEditTxDocId), {
                        total: newTotal,
                        pesanan: newPesanan
                    });
                    showMessage("Transaksi berhasil diperbarui.");
                    editTransactionModalOverlay.classList.add('hidden');
                }
            } catch (error) {
                console.error("Error updating transaction:", error);
                showMessage("Gagal memperbarui transaksi. Pastikan format JSON benar.", true);
            }
        });

        window.openQRISModal = function() {
            const total = parseInt(cartTotalEl.textContent.replace('Rp ', '').replace(/\./g, ''));
            const imageUrl = `https://placehold.co/800x800/292B4F/FFF?text=QRIS+%20Rp${total.toLocaleString('id-ID')}`;
            enlargedQrisImageEl.src = imageUrl;
            qrisModalOverlay.classList.remove('hidden');
        }

        window.closeQRISModal = function() {
            qrisModalOverlay.classList.add('hidden');
        }


        async function initialize() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    console.log("Pengguna terautentikasi:", currentUserId);
                } else {
                    currentUserId = crypto.randomUUID();
                    console.log("Pengguna anonim:", currentUserId);
                    await signInAnonymously(auth);
                }
                authStatusEl.textContent = `Masuk sebagai: ${currentUserId}`;

                // Listeners for public data
                onSnapshot(collection(db, "menu"), (snapshot) => {
                    editableMenuItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderMenuItems();
                    renderManageableMenu();
                });

                onSnapshot(collection(db, "transactions"), (snapshot) => {
                    transactions = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        timestamp: doc.data().timestamp?.toDate()
                    }));
                    transactions.sort((a, b) => (b.timestamp?.getTime() || 0) - (a.timestamp?.getTime() || 0));
                    if (activeTab === 'riwayat') {
                        renderTransactionHistory();
                    }
                });

                // Listeners for user-specific data
                const expensesRef = collection(db, `users/${currentUserId}/expenses`);
                onSnapshot(expensesRef, (snapshot) => {
                    expenses = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        timestamp: doc.data().timestamp?.toDate()
                    }));
                    expenses.sort((a, b) => (b.timestamp?.getTime() || 0) - (a.timestamp?.getTime() || 0));
                    if (activeTab === 'laporan') {
                        renderReports();
                    }
                });

                const notesRef = collection(db, `users/${currentUserId}/notes`);
                onSnapshot(notesRef, (snapshot) => {
                    notes = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        timestamp: doc.data().timestamp?.toDate()
                    }));
                    notes.sort((a, b) => (b.timestamp?.getTime() || 0) - (a.timestamp?.getTime() || 0));
                    if (activeTab === 'catatan') {
                        renderNotes();
                    }
                });


                document.getElementById('tab-makanan').click(); // Default to Makanan tab
                document.getElementById('tab-kasir').click(); // Default to Kasir tab
            });
        }

        function showMessage(message, isError = false) {
            messageText.textContent = message;
            messageText.classList.toggle('text-red-600', isError);
            messageText.classList.toggle('text-gray-800', !isError);
            messageModalOverlay.classList.remove('hidden');
        }

        window.openEditModal = function(docId, name, price) {
            currentEditDocId = docId;
            editItemNameEl.value = name;
            editItemPriceEl.value = price;
            editModalOverlay.classList.remove('hidden');
        }

        window.openEditTransactionModal = function(docId) {
            currentEditTxDocId = docId;
            const transaction = transactions.find(tx => tx.id === docId);
            if (transaction) {
                editTxTotalEl.value = transaction.total;
                editTxPesananEl.value = transaction.pesanan;
                editTransactionModalOverlay.classList.remove('hidden');
            } else {
                showMessage("Transaksi tidak ditemukan.", true);
            }
        }

        window.deleteTransaction = async function(docId) {
            try {
                await deleteDoc(doc(db, "transactions", docId));
                showMessage("Transaksi berhasil dihapus.");
            } catch (error) {
                console.error("Error removing transaction:", error);
                showMessage("Gagal menghapus transaksi. Silakan coba lagi.", true);
            }
        }

        function renderMenuItems() {
            menuItemsEl.innerHTML = '';
            const currentMenu = editableMenuItems.filter(item => item.category === activeCategory);
            
            if (currentMenu.length === 0) {
                menuItemsEl.innerHTML = `<p class="text-gray-500 col-span-full text-center py-8">Menu di kategori ini masih kosong.</p>`;
                return;
            }
            
            currentMenu.forEach(item => {
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-lg shadow cursor-pointer transform hover:scale-105 transition-transform duration-200 text-center";
                card.innerHTML = `
                    <p class="font-semibold text-gray-800">${item.name}</p>
                    <p class="text-sm text-gray-500">Rp ${item.price.toLocaleString('id-ID')}</p>
                `;
                card.addEventListener('click', () => tambahKeKeranjang(item.name, item.price));
                menuItemsEl.appendChild(card);
            });
        }

        function renderManageableMenu() {
            manajemenMenuListEl.innerHTML = '';
            
            if (editableMenuItems.length === 0) {
                manajemenMenuListEl.innerHTML = `<p class="text-white text-center py-4">Tidak ada menu yang terdaftar.</p>`;
                return;
            }
            
            const categories = editableMenuItems.reduce((acc, item) => {
                acc[item.category] = acc[item.category] || [];
                acc[item.category].push(item);
                return acc;
            }, {});

            for (const category in categories) {
                const categoryTitle = document.createElement('h3');
                categoryTitle.className = "text-lg font-bold mt-4 mb-2 text-white capitalize";
                categoryTitle.textContent = category;
                manajemenMenuListEl.appendChild(categoryTitle);

                categories[category].forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = "flex justify-between items-center bg-white bg-opacity-10 p-2 rounded-lg mb-2 cursor-pointer";
                    itemEl.innerHTML = `
                        <span class="text-sm text-white">${item.name} - Rp ${item.price.toLocaleString('id-ID')}</span>
                        <button class="bg-red-500 text-white text-xs px-2 py-1 rounded-full hover:bg-red-600 transition-colors duration-200" data-doc-id="${item.id}" data-item-name="${item.name}" data-item-category="${item.category}" onclick="event.stopPropagation(); deleteMenuItem(this.dataset.docId, this.dataset.itemName);">Hapus</button>
                    `;
                    itemEl.addEventListener('click', () => openEditModal(item.id, item.name, item.price));
                    manajemenMenuListEl.appendChild(itemEl);
                });
            }
        }
        
        window.deleteMenuItem = async function(docId, itemName) {
            try {
                await deleteDoc(doc(db, "menu", docId));
                showMessage(`Menu '${itemName}' berhasil dihapus.`);
            } catch (error) {
                console.error("Error removing document: ", error);
                showMessage("Gagal menghapus menu. Silakan coba lagi.", true);
            }
        }


        window.tambahKeKeranjang = function(item, price) {
            if (cart[item]) {
                cart[item].jumlah += 1;
            } else {
                cart[item] = { harga: price, jumlah: 1 };
            }
            renderCart();
        }
        
        window.kurangiDariKeranjang = function(item) {
            if (cart[item] && cart[item].jumlah > 1) {
                cart[item].jumlah -= 1;
            } else {
                delete cart[item];
            }
            renderCart();
        }

        function renderCart() {
            cartItemsEl.innerHTML = '';
            let total = 0;
            if (Object.keys(cart).length === 0) {
                cartItemsEl.innerHTML = `<p class="text-sm text-center text-gray-400">Keranjang kosong.</p>`;
            } else {
                for (const item in cart) {
                    const { harga, jumlah } = cart[item];
                    const itemTotal = harga * jumlah;
                    total += itemTotal;
                    
                    const cartItemEl = document.createElement('div');
                    cartItemEl.className = "flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0";
                    cartItemEl.innerHTML = `
                        <div class="flex-1">
                            <p class="font-medium text-gray-700">${item}</p>
                            <p class="text-sm text-gray-500">Rp ${harga.toLocaleString('id-ID')} x ${jumlah}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="kurangiDariKeranjang('${item}')" class="text-red-500 hover:text-red-700 font-bold text-lg leading-none">-</button>
                            <span class="font-semibold text-gray-800 w-8 text-center">Rp ${(itemTotal).toLocaleString('id-ID')}</span>
                            <button onclick="tambahKeKeranjang('${item}', ${harga})" class="text-green-500 hover:text-green-700 font-bold text-lg leading-none">+</button>
                        </div>
                    `;
                    cartItemsEl.appendChild(cartItemEl);
                }
            }
            cartTotalEl.textContent = `Rp ${total.toLocaleString('id-ID')}`;
        }

        async function processPayment() {
            const total = parseInt(cartTotalEl.textContent.replace('Rp ', '').replace(/\./g, ''));
            const paymentMethod = paymentMethodEl.value;

            if (Object.keys(cart).length === 0) {
                showMessage("Keranjang belanja masih kosong.");
                return;
            }

            if (paymentMethod === 'cash') {
                const bayar = parseInt(inputBayarEl.value);
                if (isNaN(bayar) || bayar < total) {
                    showMessage("Jumlah pembayaran tidak valid atau kurang.");
                    return;
                }
                const kembalian = bayar - total;
                kembalianAmountEl.textContent = `Rp ${kembalian.toLocaleString('id-ID')}`;
                saveTransaction(total, bayar, kembalian, 'Tunai');
            } else if (paymentMethod === 'qris') {
                qrisImageEl.src = `https://placehold.co/400x400/292B4F/FFF?text=QRIS+%20Rp${total.toLocaleString('id-ID')}`;
                kembalianAmountEl.textContent = `Rp 0`; // QRIS has no change
                saveTransaction(total, total, 0, 'QRIS');
            }
        }

        async function saveTransaction(total, bayar, kembalian, method) {
            try {
                const transactionsCollectionRef = collection(db, "transactions");
                await addDoc(transactionsCollectionRef, {
                    pesanan: JSON.stringify(cart),
                    total: total,
                    bayar: bayar,
                    kembalian: kembalian,
                    metode: method,
                    timestamp: serverTimestamp()
                });
                showMessage("Transaksi berhasil disimpan!");
            } catch (error) {
                console.error("Error saving transaction: ", error);
                showMessage("Gagal menyimpan transaksi.", true);
            }
            
            formBayarEl.classList.add('hidden');
            kembalianInfoEl.classList.remove('hidden');
        }

        function resetTransaksi() {
            cart = {};
            renderCart();
            inputBayarEl.value = '';
            formBayarEl.classList.remove('hidden');
            kembalianInfoEl.classList.add('hidden');
            paymentMethodEl.value = 'cash';
            cashPaymentFormEl.classList.remove('hidden');
            qrisPaymentFormEl.classList.add('hidden');
        }

        
        function renderTransactionHistory() {
            riwayatTabContentEl.innerHTML = '';
            if (transactions.length === 0) {
                riwayatTabContentEl.innerHTML = `<p class="text-indigo-200 text-center py-4">Belum ada riwayat transaksi.</p>`;
                return;
            }
            
            transactions.forEach((tx, index) => {
                const txEl = document.createElement('div');
                txEl.className = "bg-white bg-opacity-10 p-3 rounded-lg mb-2";
                
                let detailPesanan = '';
                try {
                    const pesanan = JSON.parse(tx.pesanan);
                    for (const item in pesanan) {
                        const { harga, jumlah } = pesanan[item];
                        detailPesanan += `<p class="text-xs text-indigo-200">- ${item} (${jumlah}x): Rp ${(harga * jumlah).toLocaleString('id-ID')}</p>`;
                    }
                } catch (e) {
                    detailPesanan = `<p class="text-xs text-red-300">Data pesanan rusak.</p>`;
                }

                txEl.innerHTML = `
                    <p class="text-sm font-semibold">Transaksi #${transactions.length - index}</p>
                    <p class="text-xs text-indigo-300">${tx.timestamp ? tx.timestamp.toLocaleString('id-ID') : 'Tanggal tidak tersedia'}</p>
                    <p class="text-lg font-bold my-1">Total: Rp ${tx.total.toLocaleString('id-ID')}</p>
                    <p class="text-sm text-indigo-300 mt-1">Metode: <span class="font-semibold">${tx.metode}</span></p>
                    <div class="mt-2 text-sm">
                        <p class="font-semibold">Detail Pesanan:</p>
                        ${detailPesanan}
                    </div>
                    <div class="flex justify-end space-x-2 mt-2">
                        <button onclick="openEditTransactionModal('${tx.id}')" class="bg-yellow-500 text-white text-xs px-3 py-1 rounded-full hover:bg-yellow-600">Edit</button>
                        <button onclick="deleteTransaction('${tx.id}')" class="bg-red-500 text-white text-xs px-3 py-1 rounded-full hover:bg-red-600">Hapus</button>
                    </div>
                `;
                riwayatTabContentEl.appendChild(txEl);
            });
        }

        function renderReports() {
            laporanListEl.innerHTML = '';
            if (expenses.length === 0) {
                laporanListEl.innerHTML = `<p class="text-white text-center py-4">Belum ada data pengeluaran.</p>`;
                return;
            }

            let totalPengeluaran = 0;
            expenses.forEach(expense => {
                totalPengeluaran += expense.amount;
                const expenseEl = document.createElement('div');
                expenseEl.className = "flex justify-between items-center bg-white bg-opacity-10 p-2 rounded-lg mb-2";
                expenseEl.innerHTML = `
                    <span class="text-sm text-white">${expense.name}</span>
                    <span class="text-sm text-white">Rp ${expense.amount.toLocaleString('id-ID')}</span>
                `;
                laporanListEl.appendChild(expenseEl);
            });
            
            const totalEl = document.createElement('div');
            totalEl.className = "flex justify-between items-center bg-white text-indigo-600 p-3 rounded-lg font-bold mt-4";
            totalEl.innerHTML = `
                <span>TOTAL PENGELUARAN:</span>
                <span>Rp ${totalPengeluaran.toLocaleString('id-ID')}</span>
            `;
            laporanListEl.appendChild(totalEl);
        }

        function renderNotes() {
            notesListEl.innerHTML = '';
            if (notes.length === 0) {
                notesListEl.innerHTML = `<p class="text-white text-center py-4">Belum ada catatan.</p>`;
                return;
            }
            notes.forEach(note => {
                const noteEl = document.createElement('div');
                noteEl.className = "bg-white bg-opacity-10 p-3 rounded-lg mb-2";
                noteEl.innerHTML = `
                    <p class="text-sm text-white mb-2">${note.text}</p>
                    <p class="text-xs text-indigo-300">${note.timestamp ? note.timestamp.toLocaleString('id-ID') : 'Tanggal tidak tersedia'}</p>
                `;
                notesListEl.appendChild(noteEl);
            });
        }
    </script>
</body>
</html>